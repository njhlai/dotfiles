#!/bin/sh

echo "bspwm: starting..." >> .xsession-errors &
# kill lingering lemonbar and dunst
pkill -x powerlemon
pkill -x lemonbar
pkill dunst

bspc monitor HDMI-0 -d 壱 弐 参 肆 伍 陸
gap=6

export GDK_SCALE=2 &
export GDK_DPI_SCALE=0.4 &
. ~/.private/env.bash

# set wallpaper. lemonbar and dunst
feh --bg-fill ~/pictures/wallpapers/shouko.png &
~/.config/lemonbar/powerlemon &
dunst -config ~/.config/dunst/dunstrc &

# This creates negative padding equal to window gap so that gaps are shown only between windows and not on desktop edges.
bspc config window_gap $gap
bspc config top_padding $((1-$gap))
for side in right bottom left ; do
	bspc config ${side}_padding -$gap
done &

# configuration
bspc config split_ratio          	0.52
bspc config borderless_monocle   	true
bspc config gapless_monocle      	true
bspc config automatic_scheme 		alternate
bspc config center_pseudo_tiled		false

# border config
bspc config border_width         	2
bspc config normal_border_color 	"#534A65"
bspc config focused_border_color	"#d37961"
bspc config presel_feedback_color 	"#ff5555"

# Apps settings
## 伍 (terminal)
bspc rule -a Alacritty desktop='^5' follow=on focus=on

### Building receptacles for 伍
bspc desktop -f '^5'
bspc node @/ -i
bspc node @/ -p west -i
bspc node @/2 -o 0.6 -p south -i
bspc rule -a Alacritty:primary -o node=@/1
bspc rule -a Alacritty:top -o node=@/2/1
bspc rule -a Alacritty:secondary -o node=@/2/2

## 肆 (dev)
bspc rule -a Sublime_text desktop='^4' split_dir="west" split_ratio="0.685"follow=on focus=on
bspc rule -a Zathura desktop='^4' split_dir="east" split_ratio="0.685" state=tiled follow=on focus=on

## 弐 (browser)
bspc rule -a firefox desktop='^2' follow=on focus=on
bspc rule -a Vlc desktop='^2' follow=on focus=on

## 壱 (messenger)
bspc rule -a discord desktop='^1' follow=on focus=on

## 陸 (media)
bspc rule -a Lutris desktop='^6' follow=on focus=on
bspc rule -a Steam desktop='^6' state=pseudo_tiled follow=on focus=on
bspc rule -a Alacritty:jukebox desktop='^6' state=pseudo_tiled rectangle=650x900+0+0 follow=on focus=on
bspc rule -a vlc desktop='^6' follow=on focus=on

### games are all in 陸
mygames=$(ls ~/.steam/steam/steamapps/ | grep appmanifest | sed 's/[^0-9]*//g')
for game in $mygames; do
        bspc rule -a steam_app_$game desktop='^6' state=fullscreen follow=on
done &
# for some reason SC2 doesn't go fullscreen and instead goes tiled, so go float and then fullscreen and switch to fullscreen in game
# TODO: find a fix for this
bspc rule -a sc2_x64.exe desktop='^6' state=floating follow=on

## floating
bspc rule -a Xfce4-terminal state=floating

##  参 (floating)
FLOATING_DESKTOP_ID=$(bspc query -D -d '^3')

bspc subscribe node_add | while read -a msg ; do
    desk_id=${msg[2]}
    wid=${msg[4]}
    [ "$FLOATING_DESKTOP_ID" = "$desk_id" ] && bspc node "$wid" -t floating
done &

echo "bspwm: finished setting up" >> .xsession-errors &