#!/bin/bash
#
# Music info display via dunst

. ~/.private/env.bash

title=$(mpc current -f "%title%|%file%" 2> /dev/null)

if [[ ${title} ]] ; then
	cover=/tmp/musicart.png
	[[ ! -f ${cover} ]] && ffmpeg -i "${LOCAL_MPD_MUSIC_DIR}/$(mpc current -f %file% 2> /dev/null)" "${cover}" -y > /dev/null 2>&1
	[[ -f ${cover} ]] || cover="gmpc"

	metadata=$(mpc current -f "%artist%[\n<small><i>%album%</i></small>]" 2> /dev/null)
	progress=$(mpc status 2> /dev/null | grep -oP '\[[a-z]*\].*?\(\K[0-9]+')

	# open issue in dunst-project/dunst/issues/1061, temp fix using replaceid based on github.com/owl4ce/dotfiles/commit/77f9edb9375328d7f38846b85abf9bb743f965eb
	dunstify "${title}" "${metadata}" -h int:value:${progress} -h string:x-dunst-stack-tag:music -a "MPD" -u low -i "${cover}" -r 1061
else
	# open issue in dunst-project/dunst/issues/1061, temp fix using replaceid based on github.com/owl4ce/dotfiles/commit/77f9edb9375328d7f38846b85abf9bb743f965eb
	dunstify "STOPPED" -h string:x-dunst-stack-tag:music -a "MPD" -u low -i "gmpc" -r 1061
fi